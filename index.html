<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Análise de Métricas - TikTok Shop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              '50': '#f0f3ff',
              '100': '#e0e7ff',
              '200': '#c7d2fe',
              '300': '#a5b4fc',
              '400': '#818cf8',
              '500': '#6366f1',
              '600': '#4f46e5',
              '700': '#4338ca',
              '800': '#3730a3',
              '900': '#312e81',
              '950': '#1e1b4b'
            }
          }
        }
      }
    }
  </script>
<style>
    @keyframes pulse-neon {
      0%, 100% {
        opacity: 1;
        box-shadow: 0 0 4px #39ff14, 0 0 8px #39ff14;
      }
      50% {
        opacity: 0.8;
        box-shadow: 0 0 8px #39ff14, 0 0 12px #39ff14;
      }
    }
    .progress-bar-neon {
      background-color: #39ff14; /* Verde Neon Forte */
      animation: pulse-neon 1.5s ease-in-out infinite;
    }
</style>
<script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "recharts": "https://aistudiocdn.com/recharts@^3.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "date-fns/": "https://aistudiocdn.com/date-fns@^4.1.0/",
    "date-fns": "https://aistudiocdn.com/date-fns@^4.1.0"
  }
}
</script>
</head>
<body class="bg-gray-900">
  <div id="root"></div>

  <!-- BEGIN ADD: Google Auth buttons -->
  <button id="btnGoogle">Entrar com Google</button>
  <button id="btnLogout" style="display:none">Sair</button>
  <!-- END ADD -->
  
  <script type="module" src="/index.tsx"></script>
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      GoogleAuthProvider, 
      signInWithPopup, 
      signInWithRedirect, 
      getRedirectResult,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      setDoc, 
      serverTimestamp,
      onSnapshot,
      collection,
      addDoc,
      updateDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyDh_EX_TIAuYhLz0o6HjyNclsRPPLXkjyg",
  authDomain: "dashrare-e93be.firebaseapp.com",
  projectId: "dashrare-e93be",
  storageBucket: "dashrare-e93be.appspot.com",
  messagingSenderId: "248787584417",
  appId: "1:248787584417:web:341cb53f61f1c18199b7e0"
};

console.log("API KEY ATIVA:", firebaseConfig.apiKey);



    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let unsubscribeUserWatcher = null;

    // --- Authentication ---
    const provider = new GoogleAuthProvider();

    window.signInWithGoogle = async () => {
      try {
        await signInWithPopup(auth, provider);
        alert("✅ Login realizado com sucesso!");
      } catch (error) {
        if (error.code === 'auth/popup-blocked' || error.code === 'auth/cancelled-popup-request' || error.code === 'auth/operation-not-supported-in-this-environment') {
          await signInWithRedirect(auth, provider);
        } else {
          console.error("Login com popup falhou:", error);
          alert(`❌ Falha no login: ${error.message}`);
        }
      }
    };
    
    window.signOutFirebase = async () => {
        try {
            await signOut(auth);
            alert("Você saiu da conta.");
        } catch (error) {
            console.error("Erro ao sair:", error);
            alert(`❌ Falha ao sair: ${error.message}`);
        }
    };

    getRedirectResult(auth)
      .then((result) => {
        if (result?.user) {
          alert("✅ Login realizado com sucesso!");
        }
      })
      .catch((error) => {
        console.error("Erro em getRedirectResult:", error);
        alert(`❌ Falha no login por redirecionamento: ${error.message}`);
      });

    onAuthStateChanged(auth, user => {
      const btnG = document.getElementById('btnGoogle');
      const btnL = document.getElementById('btnLogout');

      if (user) {
        btnG && (btnG.style.display = 'none');
        btnL && (btnL.style.display = 'inline-block');

        console.log("Usuário logado (Firebase):", user.uid);
        const userRef = doc(db, "users", user.uid);
        const userData = {
            email: user.email,
            displayName: user.displayName,
            photoURL: user.photoURL,
            lastLoginAt: serverTimestamp()
        };
        setDoc(userRef, userData, { merge: true });

        window.dispatchEvent(new CustomEvent('firebase-auth-state-changed', {
          detail: { loggedIn: true, user: { uid: user.uid, email: user.email, displayName: user.displayName, photoURL: user.photoURL } }
        }));

        // Inicia o listener de dados do usuário e loga as mudanças
        unsubscribeUserWatcher = window.watchUserData(data => {
            console.log("Dados do usuário (Firestore):", data);
        });
        
        console.log("Indicando onde carregar dados do usuário no dashboard...");

      } else {
        btnG && (btnG.style.display = 'inline-block');
        btnL && (btnL.style.display = 'none');
        
        console.log("Usuário deslogado (Firebase).");
        if (unsubscribeUserWatcher) {
            console.log("Interrompendo listener de dados do usuário.");
            unsubscribeUserWatcher();
            unsubscribeUserWatcher = null;
        }
        window.dispatchEvent(new CustomEvent('firebase-auth-state-changed', {
          detail: { loggedIn: false, user: null }
        }));
      }
    });

    // --- Firestore Profile Utilities ---
    window.saveUserData = (partialData) => {
      const user = auth.currentUser;
      if (user) {
        const userRef = doc(db, "users", user.uid);
        return setDoc(userRef, partialData, { merge: true });
      }
      return Promise.reject("Nenhum usuário logado.");
    };

    window.watchUserData = (callback) => {
      const user = auth.currentUser;
      if (user) {
        const userRef = doc(db, "users", user.uid);
        return onSnapshot(userRef, snap => {
          callback(snap.data() || {});
        });
      }
      console.warn("watchUserData chamado sem usuário logado.");
      return () => {}; // Retorna uma função vazia para evitar erros
    };

    // --- Firestore Subcollection Generic Utilities ---

    window.watchUserSubcollection = (collectionName, callback) => {
      const user = auth.currentUser;
      if (user) {
        const collectionRef = collection(db, "users", user.uid, collectionName);
        return onSnapshot(collectionRef, (querySnapshot) => {
          const data = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          // Firestore Timestamps to ISOString for easier handling in JS
          const processedData = data.map(item => {
            for (const key in item) {
              if (item[key] && typeof item[key].toDate === 'function') {
                item[key] = item[key].toDate().toISOString();
              }
            }
            return item;
          });
          callback(processedData);
        }, (error) => {
          console.error(`Error watching ${collectionName}:`, error);
        });
      }
      console.warn(`watchUserSubcollection (${collectionName}) called without user.`);
      return () => {};
    };

    window.addUserSubcollectionDoc = (collectionName, data) => {
      const user = auth.currentUser;
      if (user) {
        const collectionRef = collection(db, "users", user.uid, collectionName);
        const { id, ...docData } = data; // Don't save our own id field
        docData.createdAt = serverTimestamp();
        return addDoc(collectionRef, docData);
      }
      return Promise.reject("No user logged in.");
    };

    window.updateUserSubcollectionDoc = (collectionName, docId, data) => {
      const user = auth.currentUser;
      if (user) {
        const docRef = doc(db, "users", user.uid, collectionName, docId);
        const { id, ...docData } = data; // Don't save our own id field
        return setDoc(docRef, docData, { merge: true });
      }
      return Promise.reject("No user logged in.");
    };

    window.deleteUserSubcollectionDoc = (collectionName, docId) => {
      const user = auth.currentUser;
      if (user) {
        const docRef = doc(db, "users", user.uid, collectionName, docId);
        return deleteDoc(docRef);
      }
      return Promise.reject("No user logged in.");
    };

    // Liga os botões globais
    document.getElementById('btnGoogle')?.addEventListener('click', window.signInWithGoogle);
    document.getElementById('btnLogout')?.addEventListener('click', () => signOut(auth));
  </script>
</body>
</html>