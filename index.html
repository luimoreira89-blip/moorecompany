<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Análise de Métricas - TikTok Shop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              '50': '#f0f9ff',
              '100': '#e0f2fe',
              '200': '#bae6fd',
              '300': '#7dd3fc',
              '400': '#38bdf8',
              '500': '#0ea5e9',
              '600': '#0284c7',
              '700': '#0369a1',
              '800': '#075985',
              '900': '#0c4a6e',
              '950': '#082f49'
            },
            'dark-bg': '#191919',
          }
        }
      }
    }
  </script>
<style>
    @keyframes pulse-neon {
      0%, 100% {
        opacity: 1;
        box-shadow: 0 0 4px #a3e635, 0 0 8px #a3e635;
      }
      50% {
        opacity: 0.8;
        box-shadow: 0 0 8px #a3e635, 0 0 12px #a3e635;
      }
    }
    .progress-bar-neon {
      background-color: #84cc16; /* Verde Neon (lime-500) */
      animation: pulse-neon 1.5s ease-in-out infinite;
    }
</style>
<script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "recharts": "https://aistudiocdn.com/recharts@^3.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "date-fns/": "https://aistudiocdn.com/date-fns@^3.6.0/",
    "date-fns": "https://aistudiocdn.com/date-fns@^3.6.0"
  }
}
</script>
</head>
<body class="bg-black">
  <div id="root"></div>

  <!-- Botão de Logout permanece -->
  <button id="btnLogout" style="display:none">Sair</button>
  
  <script type="module" src="/index.tsx"></script>
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      setDoc, 
      serverTimestamp,
      onSnapshot,
      collection,
      addDoc,
      updateDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDh_EX_TIAuYhLz0o6HjyNclsRPPLXkjyg",
      authDomain: "dashrare-e93be.firebaseapp.com",
      projectId: "dashrare-e93be",
      storageBucket: "dashrare-e93be.appspot.com",
      messagingSenderId: "248787584417",
      appId: "1:248787584417:web:341cb53f61f1c18199b7e0"
    };

    console.log("API KEY ATIVA:", firebaseConfig.apiKey);

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let unsubscribeUserWatcher = null;

    // --- Authentication com Email e Senha ---
    window.signUpWithEmailPassword = (email, password) => {
      return createUserWithEmailAndPassword(auth, email, password);
    };

    window.signInWithEmailPassword = (email, password) => {
      return signInWithEmailAndPassword(auth, email, password);
    };
    
    window.signOutFirebase = async () => {
        try {
            await signOut(auth);
            // O evento onAuthStateChanged vai lidar com a atualização da UI
        } catch (error) {
            console.error("Erro ao sair:", error);
            alert(`❌ Falha ao sair: ${error.message}`);
        }
    };

    onAuthStateChanged(auth, user => {
      const btnL = document.getElementById('btnLogout');

      if (user) {
        btnL && (btnL.style.display = 'inline-block');

        console.log("Usuário logado (Firebase):", user.uid);
        const userRef = doc(db, "users", user.uid);
        const userData = {
            email: user.email,
            displayName: user.displayName || user.email.split('@')[0], // Fallback para displayName
            photoURL: user.photoURL, // Pode ser nulo
            lastLoginAt: serverTimestamp()
        };
        // Cria ou atualiza o perfil do usuário no Firestore
        setDoc(userRef, userData, { merge: true });

        window.dispatchEvent(new CustomEvent('firebase-auth-state-changed', {
          detail: { loggedIn: true, user: { uid: user.uid, email: user.email, displayName: userData.displayName, photoURL: user.photoURL } }
        }));

        // Inicia o listener de dados do usuário
        if (!unsubscribeUserWatcher) {
            unsubscribeUserWatcher = window.watchUserData(data => {
                console.log("Dados do usuário (Firestore):", data);
            });
        }
        
      } else {
        btnL && (btnL.style.display = 'none');
        
        console.log("Usuário deslogado (Firebase).");
        if (unsubscribeUserWatcher) {
            console.log("Interrompendo listener de dados do usuário.");
            unsubscribeUserWatcher();
            unsubscribeUserWatcher = null;
        }
        window.dispatchEvent(new CustomEvent('firebase-auth-state-changed', {
          detail: { loggedIn: false, user: null }
        }));
      }
    });

    // --- Firestore Profile Utilities ---
    window.saveUserData = (partialData) => {
      const user = auth.currentUser;
      if (user) {
        const userRef = doc(db, "users", user.uid);
        return setDoc(userRef, partialData, { merge: true });
      }
      return Promise.reject("Nenhum usuário logado.");
    };

    window.watchUserData = (callback) => {
      const user = auth.currentUser;
      if (user) {
        const userRef = doc(db, "users", user.uid);
        return onSnapshot(userRef, snap => {
          callback(snap.data() || {});
        });
      }
      console.warn("watchUserData chamado sem usuário logado.");
      return () => {}; // Retorna uma função vazia para evitar erros
    };

    // --- Firestore Subcollection Generic Utilities ---

    window.watchUserSubcollection = (collectionName, callback) => {
      const user = auth.currentUser;
      if (user) {
        const collectionRef = collection(db, "users", user.uid, collectionName);
        return onSnapshot(collectionRef, (querySnapshot) => {
          const data = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          // Firestore Timestamps to ISOString for easier handling in JS
          const processedData = data.map(item => {
            for (const key in item) {
              if (item[key] && typeof item[key].toDate === 'function') {
                item[key] = item[key].toDate().toISOString();
              }
            }
            return item;
          });
          callback(processedData);
        }, (error) => {
          console.error(`Error watching ${collectionName}:`, error);
        });
      }
      console.warn(`watchUserSubcollection (${collectionName}) called without user.`);
      return () => {};
    };

    window.addUserSubcollectionDoc = (collectionName, data) => {
      const user = auth.currentUser;
      if (user) {
        const collectionRef = collection(db, "users", user.uid, collectionName);
        const { id, ...docData } = data; // Don't save our own id field
        docData.createdAt = serverTimestamp();
        return addDoc(collectionRef, docData);
      }
      return Promise.reject("No user logged in.");
    };

    window.updateUserSubcollectionDoc = (collectionName, docId, data) => {
      const user = auth.currentUser;
      if (user) {
        const docRef = doc(db, "users", user.uid, collectionName, docId);
        const { id, ...docData } = data; // Don't save our own id field
        return setDoc(docRef, docData, { merge: true });
      }
      return Promise.reject("No user logged in.");
    };

    window.deleteUserSubcollectionDoc = (collectionName, docId) => {
      const user = auth.currentUser;
      if (user) {
        const docRef = doc(db, "users", user.uid, collectionName, docId);
        return deleteDoc(docRef);
      }
      return Promise.reject("No user logged in.");
    };

    // Liga os botões globais
    document.getElementById('btnLogout')?.addEventListener('click', window.signOutFirebase);
  </script>
</body>
</html>