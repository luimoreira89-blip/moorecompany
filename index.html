<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Análise de Métricas - TikTok Shop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              '50': '#f0f3ff',
              '100': '#e0e7ff',
              '200': '#c7d2fe',
              '300': '#a5b4fc',
              '400': '#818cf8',
              '500': '#6366f1',
              '600': '#4f46e5',
              '700': '#4338ca',
              '800': '#3730a3',
              '900': '#312e81',
              '950': '#1e1b4b'
            }
          }
        }
      }
    }
  </script>
<style>
    @keyframes pulse-neon {
      0%, 100% {
        opacity: 1;
        box-shadow: 0 0 4px #39ff14, 0 0 8px #39ff14;
      }
      50% {
        opacity: 0.8;
        box-shadow: 0 0 8px #39ff14, 0 0 12px #39ff14;
      }
    }
    .progress-bar-neon {
      background-color: #39ff14; /* Verde Neon Forte */
      animation: pulse-neon 1.5s ease-in-out infinite;
    }
</style>
<script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "recharts": "https://aistudiocdn.com/recharts@^3.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "date-fns/": "https://aistudiocdn.com/date-fns@^4.1.0/",
    "date-fns": "https://aistudiocdn.com/date-fns@^4.1.0"
  }
}
</script>
</head>
<body class="bg-gray-900">
  <div id="root"></div>
  <script type="module" src="/index.tsx"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      GoogleAuthProvider, 
      signInWithPopup, 
      signInWithRedirect, 
      getRedirectResult,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      setDoc, 
      serverTimestamp,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyDh_EX_TIAuYhLz0o6HjyNclsRPPLXkjyg",
  authDomain: "dashrare-e93be.firebaseapp.com",
  projectId: "dashrare-e93be",
  storageBucket: "dashrare-e93be.appspot.com",
  messagingSenderId: "248787584417",
  appId: "1:248787584417:web:341cb53f61f1c18199b7e0"
};

console.log("API KEY ATIVA:", firebaseConfig.apiKey);



    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let unsubscribeUserWatcher = null;

    // --- Authentication ---
    const provider = new GoogleAuthProvider();

    window.signInWithGoogle = () => {
      signInWithPopup(auth, provider).catch((error) => {
        if (error.code === 'auth/popup-blocked' || error.code === 'auth/cancelled-popup-request') {
          signInWithRedirect(auth, provider);
        } else {
          console.error("Login com popup falhou:", error);
          alert(`Falha no login: ${error.message}`);
        }
      });
    };
    
    window.signOutFirebase = () => {
        signOut(auth).catch(error => {
            console.error("Erro ao sair:", error);
        });
    };

    getRedirectResult(auth).catch(error => {
      console.error("Erro em getRedirectResult:", error);
    });

    onAuthStateChanged(auth, user => {
      if (user) {
        console.log("Usuário logado (Firebase):", user.uid);
        const userRef = doc(db, "users", user.uid);
        const userData = {
            email: user.email,
            displayName: user.displayName,
            photoURL: user.photoURL,
            lastLoginAt: serverTimestamp()
        };
        setDoc(userRef, userData, { merge: true });

        window.dispatchEvent(new CustomEvent('firebase-auth-state-changed', {
          detail: { loggedIn: true, user: { uid: user.uid, email: user.email, displayName: user.displayName, photoURL: user.photoURL } }
        }));

        // Inicia o listener de dados do usuário e loga as mudanças
        unsubscribeUserWatcher = window.watchUserData(data => {
            console.log("Dados do usuário (Firestore):", data);
        });
        
        console.log("Indicando onde carregar dados do usuário no dashboard...");

      } else {
        console.log("Usuário deslogado (Firebase).");
        if (unsubscribeUserWatcher) {
            console.log("Interrompendo listener de dados do usuário.");
            unsubscribeUserWatcher();
            unsubscribeUserWatcher = null;
        }
        window.dispatchEvent(new CustomEvent('firebase-auth-state-changed', {
          detail: { loggedIn: false, user: null }
        }));
      }
    });

    // --- Firestore Utilities ---
    window.saveUserData = (partialData) => {
      const user = auth.currentUser;
      if (user) {
        const userRef = doc(db, "users", user.uid);
        return setDoc(userRef, partialData, { merge: true });
      }
      return Promise.reject("Nenhum usuário logado.");
    };

    window.watchUserData = (callback) => {
      const user = auth.currentUser;
      if (user) {
        const userRef = doc(db, "users", user.uid);
        return onSnapshot(userRef, snap => {
          callback(snap.data() || {});
        });
      }
      console.warn("watchUserData chamado sem usuário logado.");
      return () => {}; // Retorna uma função vazia para evitar erros
    };

  </script>
</body>
</html>